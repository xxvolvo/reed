{
    "version": 3,
    "sources": [
        "..\\..\\..\\..\\src\\admin\\controller\\system\\photo.js"
    ],
    "names": [],
    "mappings": "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",
    "file": "..\\..\\..\\..\\src\\admin\\controller\\system\\photo.js",
    "sourcesContent": [
        "'use strict';\n\nimport Base from '../base.js';\n\nexport default class extends Base {\n  /**\n   * index action\n   * @return {Promise} []\n   */\n  async indexAction(){\n    let page_index=this.get(\"page\");\n    let name=this.get(\"name\");\n    let category_code=this.get(\"category_code\");\n\n    let search={};\n    if(name&&name.length>0){\n      search.name=['like','%'+name+'%'];\n    }\n    if(category_code&&category_code.length>0){\n      search.category_code=category_code;\n    }\n    this.assign(\"name\",name);\n    this.assign(\"category_code\",category_code);\n    if(!page_index) page_index=1;\n    let page_count=10;\n    let model=this.model(\"pictures\");\n    let raw_data=await model.page(page_index,page_count).where(search).countSelect();\n\n    let category_model=this.model(\"pictures\");\n    let category_data=await category_model.query('select distinct category,category_code from pictures');\n\n    this.assign(\"photos\",raw_data.data);\n    this.assign(\"categorys\",category_data);\n    this.assign(\"currentPage\",raw_data.currentPage);\n    this.assign(\"itemsCount\",raw_data.count);\n    this.assign(\"totalPages\",raw_data.totalPages);\n    this.assign(\"startPage\",(page_index-1)*page_count+1);\n    this.assign(\"endPage\",Math.min(page_index*page_count,raw_data.count));\n    return this.display();\n  }\n\n  /**\n  * update action\n  * 插入\n  * @return {Promise} []\n  */\n  async updateAction(){\n    if(this.isGet()){\n      let id=this.get(\"id\");\n      //查询图片分类 \n      let category_model=this.model(\"pictures\");\n      let category_data=await category_model.query('select distinct category,category_code from pictures');\n      //查询图片信息\n      let model=this.model(\"pictures\");\n      let data=await model.where({id:id}).find();\n      this.assign(\"photo\",data);\n      this.assign(\"categorys\",category_data);\n      return this.display();\n    }\n\n    let id=this.post(\"id\"),\n        description=this.post(\"description\"),\n        category_code=this.post(\"category_code\"),\n        new_category=this.post(\"new_category\"),\n        new_category_code=this.post(\"new_category_code\"),\n        deleted=!!this.post(\"deleted\"),\n        sort=this.post(\"sort\");\n    let real_category='',real_category_code='';\n    if(new_category&&new_category.length>0){\n      real_category=new_category.trim();\n      real_category_code=new_category_code.trim();\n    }else{\n      let split=category_code.split(\"#@!\");\n      real_category=split[1];\n      real_category_code=split[0];\n    }\n    //上传图片\n    var uuid=require('uuid');\n    var createdat=new Date();\n\n    let to_update={\n      uuid:uuid.v4().toString(),\n      description:description,\n      category:real_category,\n      category_code:real_category_code,\n      sort:sort,\n      deleted:deleted,\n      createdat:createdat.toLocaleString(),\n      updatedat:createdat.toLocaleString()\n    };\n    let file=this.file(\"file\");\n    if(file.size){\n      let path=require('path');\n      let extname=path.extname(file.originalFilename);\n      let qiniu=require('../../../common/util/qiniu-yun.js');\n      let imgname=uuid.v4().toString().replace(/-/g,'').substr(0,16)+extname;\n      let pic_url='static/uimages/'+real_category_code+'/'+imgname;\n      let upload_result=await qiniu.upload(file.path,pic_url);\n      pic_url=\"/\"+pic_url;\n\n      to_update.name=imgname;\n      to_update.url=pic_url;\n      to_update.path='/static/uimages/'+real_category_code+'/';\n    }\n    //插入数据\n    var model=this.model(\"pictures\");\n\n    await model.where({id:id}).update(to_update);\n    return this.redirect(\"/system/photo/index\");\n  }\n\n  /**\n  * insert action\n  * 插入\n  * @return {Promise} []\n  */\n  async insertAction(){\n    if(this.isGet()){\n      //查询图片分类\n      let category_model=this.model(\"pictures\");\n      let category_data=await category_model.query('select distinct category,category_code from pictures');\n\n      this.assign(\"categorys\",category_data);\n      return this.display();\n    }\n\n    let description=this.post(\"description\"),\n        category_code=this.post(\"category_code\"),\n        new_category=this.post(\"new_category\"),\n        new_category_code=this.post(\"new_category_code\"),\n        deleted=!!this.post(\"deleted\"),\n        sort=this.post(\"sort\");\n    let real_category='',real_category_code='';\n    if(new_category&&new_category.length>0){\n      real_category=new_category.trim();\n      real_category_code=new_category_code.trim();\n    }else{\n      let split=category_code.split(\"#@!\");\n      real_category=split[1];\n      real_category_code=split[0];\n    }\n    //上传图片\n    var uuid=require('uuid');\n    let file=this.file(\"file\");\n    var path=require('path');\n    var extname=path.extname(file.originalFilename);\n    var qiniu=require('../../../common/util/qiniu-yun.js');\n    var imgname=uuid.v4().toString().replace(/-/g,'').substr(0,16)+extname;\n    var pic_url='static/uimages/'+real_category_code+'/'+imgname;\n    var upload_result=await qiniu.upload(file.path,pic_url);\n    pic_url=\"/\"+pic_url;\n    //插入数据\n    var model=this.model(\"pictures\");\n    var createdat=new Date();\n\n    let to_insert={\n      uuid:uuid.v4().toString(),\n      description:description,\n      category:real_category,\n      category_code:real_category_code,\n      name:imgname,\n      url:pic_url,\n      path:'/static/uimages/'+real_category_code+'/',\n      sort:sort,\n      deleted:deleted,\n      createdat:createdat.toLocaleString(),\n      updatedat:createdat.toLocaleString()\n    };\n    await model.add(to_insert);\n    return this.redirect(\"/system/photo/index\");\n  }\n\n  async deleteAction(){\n    if(this.isGet()){\n      this.assign(\"id\",this.get(\"id\"));\n      return this.display();\n    }\n    let id=this.post(\"id\");\n    let model=this.model(\"pictures\");\n    await model.where({id:id}).delete();\n    let http=this.http;\n    return http.redirect(\"/system/photo/index\");\n  }\n}\n"
    ]
}